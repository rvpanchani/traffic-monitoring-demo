(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const l={MAP:{DEFAULT_ZOOM:13,SEARCH_RADIUS:.045,RASTER_OPACITY:{TRAFFIC_FLOW:.6,TRAFFIC_INCIDENTS:.7,SIMPLE_TRAFFIC:.5}},TIMEOUTS:{TRAFFIC_LAYER_RETRY:3e3,LAYER_VERIFICATION:1e3},API:{GEOCODING_LIMIT:1,TILE_SIZE:256},UI:{SEARCH_DEBOUNCE:300,STATUS_TIMEOUT:5e3}},d={sanitizeHtml:f=>{const t=document.createElement("div");return t.textContent=f,t.innerHTML},sanitizeSearchInput:f=>typeof f!="string"?"":f.trim().replace(/[<>'"&]/g,"").substring(0,100),isValidCoordinate:(f,t)=>typeof f=="number"&&typeof t=="number"&&f>=-180&&f<=180&&t>=-90&&t<=90,debounce:(f,t)=>{let e;return(...n)=>{clearTimeout(e),e=setTimeout(()=>f.apply(null,n),t)}}},r={defaultLocation:{name:"Sinhgad Road, Pune",center:{lat:18.4633,lon:73.807},bbox:{minLat:18.42,maxLat:18.51,minLon:73.76,maxLon:73.85}},currentLocation:null,tomtomApiKey:"7uWXg53qqREkqTrQDSPaLJuxD03KmcfE"};r.currentLocation=r.defaultLocation;console.log("Environment variable VITE_TOMTOM_API_KEY:","Loaded");console.log("Using API key:",r.tomtomApiKey.substring(0,10)+"...");class u{constructor(){this.map=null,this.incidents=[],this.markers=[],this.searchResults=[],this.isDestroyed=!1,this.debouncedSearch=d.debounce(()=>this.handleLocationSearch(),l.UI.SEARCH_DEBOUNCE),this.init()}async init(){try{this.setupEventListeners(),await this.initializeMap(),await this.loadTrafficIncidents()}catch(t){console.error("Failed to initialize application:",t),this.updateStatus(`Initialization failed: ${t.message}`,"error")}}destroy(){this.isDestroyed=!0,this.clearMarkers(),this.map&&(this.map.remove(),this.map=null)}setupEventListeners(){const t=document.getElementById("refresh-btn"),e=document.getElementById("search-btn"),n=document.getElementById("location-search"),i=document.getElementById("toggle-traffic-flow"),o=document.getElementById("toggle-traffic-incidents");t&&t.addEventListener("click",()=>this.loadTrafficIncidents()),e&&e.addEventListener("click",()=>this.handleLocationSearch()),n&&(n.addEventListener("keypress",s=>{s.key==="Enter"&&(s.preventDefault(),this.debouncedSearch())}),n.addEventListener("input",()=>{n.value.trim().length>2?n.classList.add("ready-to-search"):n.classList.remove("ready-to-search")})),i&&i.addEventListener("click",()=>this.toggleTrafficFlow()),o&&o.addEventListener("click",()=>this.toggleTrafficIncidents())}async initializeMap(){try{if(this.isDestroyed)return;if(this.updateStatus("Initializing map...","loading"),typeof tt>"u")throw new Error("TomTom Maps SDK not loaded");!r.tomtomApiKey||r.tomtomApiKey,this.map=tt.map({key:r.tomtomApiKey,container:"map",center:[r.currentLocation.center.lon,r.currentLocation.center.lat],zoom:l.MAP.DEFAULT_ZOOM}),this.map.addControl(new tt.NavigationControl,"top-right"),this.map.addControl(new tt.FullscreenControl,"top-right"),this.map.addControl(new tt.ScaleControl({maxWidth:200,unit:"metric"}),"bottom-left"),this.map.addControl(new tt.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0}),"top-right"),this.map.on("load",()=>{this.isDestroyed||(console.log("Map load event fired"),this.addTrafficLayers())}),setTimeout(()=>{if(!this.isDestroyed&&this.map&&this.map.isStyleLoaded()){console.log("Backup timer: checking for traffic layers...");const t=this.map.getLayer("traffic-flow")||this.map.getLayer("simple-traffic"),e=this.map.getLayer("traffic-incidents-tiles");!t&&!e&&(console.log("No traffic layers found, trying to add them again..."),this.addTrafficLayers())}},l.TIMEOUTS.TRAFFIC_LAYER_RETRY),this.updateStatus("Map initialized successfully","success")}catch(t){console.error("Error initializing map:",t),this.updateStatus(`Map error: ${t.message}`,"error"),this.showDemoMode()}}addTrafficLayers(){try{if(this.isDestroyed)return;if(console.log("Adding traffic layers..."),!this.map.isStyleLoaded()){console.log("Map style not loaded yet, waiting..."),this.map.on("styledata",()=>{this.map.isStyleLoaded()&&!this.isDestroyed&&this.addTrafficLayers()});return}const t=`https://api.tomtom.com/traffic/map/4/tile/flow/relative-delay/{z}/{x}/{y}.png?key=${r.tomtomApiKey}`,e=`https://api.tomtom.com/traffic/map/4/tile/incidents/{z}/{x}/{y}.png?key=${r.tomtomApiKey}`;this.map.getSource("traffic-flow")||(console.log("Adding traffic flow source..."),this.map.addSource("traffic-flow",{type:"raster",tiles:[t],tileSize:l.API.TILE_SIZE,attribution:"Traffic data © TomTom"}),this.map.addLayer({id:"traffic-flow",type:"raster",source:"traffic-flow",paint:{"raster-opacity":l.MAP.RASTER_OPACITY.TRAFFIC_FLOW}}),console.log("Traffic flow layer added")),this.map.getSource("traffic-incidents-tiles")||(console.log("Adding traffic incidents source..."),this.map.addSource("traffic-incidents-tiles",{type:"raster",tiles:[e],tileSize:l.API.TILE_SIZE,attribution:"Incident data © TomTom"}),this.map.addLayer({id:"traffic-incidents-tiles",type:"raster",source:"traffic-incidents-tiles",paint:{"raster-opacity":l.MAP.RASTER_OPACITY.TRAFFIC_INCIDENTS}}),console.log("Traffic incidents layer added")),console.log("All traffic layers added successfully"),setTimeout(()=>{if(this.isDestroyed)return;const n=this.map.getLayer("traffic-flow"),i=this.map.getLayer("traffic-incidents-tiles");console.log("Layer verification - Flow layer:",!!n,"Incidents layer:",!!i)},l.TIMEOUTS.LAYER_VERIFICATION)}catch(t){console.error("Error adding traffic layers:",t),this.addSimpleTrafficLayer()}}addSimpleTrafficLayer(){try{if(this.isDestroyed)return;console.log("Trying simple traffic layer approach..."),this.map.getSource("simple-traffic")||(this.map.addSource("simple-traffic",{type:"raster",tiles:[`https://api.tomtom.com/traffic/map/4/tile/flow/relative/{z}/{x}/{y}.png?key=${r.tomtomApiKey}`],tileSize:l.API.TILE_SIZE}),this.map.addLayer({id:"simple-traffic",type:"raster",source:"simple-traffic",paint:{"raster-opacity":l.MAP.RASTER_OPACITY.SIMPLE_TRAFFIC}}),console.log("Simple traffic layer added"))}catch(t){console.error("Even simple traffic layer failed:",t)}}async handleLocationSearch(){const t=document.getElementById("location-search"),e=document.getElementById("search-btn");if(!t){console.error("Search input element not found");return}const n=t.value,i=d.sanitizeSearchInput(n);if(!i||i.length<2){this.updateStatus("Please enter a valid location (at least 2 characters)","error");return}try{this.updateStatus("Searching for location...","loading"),e&&(e.disabled=!0);const o=await this.geocodeLocation(i);if(!o)throw new Error("Location not found");r.currentLocation=o,this.updateCurrentLocationDisplay(o.name),this.map&&(this.map.setCenter([o.center.lon,o.center.lat]),this.map.setZoom(l.MAP.DEFAULT_ZOOM)),await this.loadTrafficIncidents(),this.updateStatus(`Switched to ${d.sanitizeHtml(o.name)}`,"success")}catch(o){console.error("Error searching location:",o),this.updateStatus(`Search error: ${o.message}`,"error")}finally{e&&(e.disabled=!1)}}async geocodeLocation(t){const n=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(d.sanitizeSearchInput(t))}.json?key=${r.tomtomApiKey}&limit=${l.API.GEOCODING_LIMIT}`;console.log("Geocoding location:",t);const i=await fetch(n);if(!i.ok){const p=await i.text().catch(()=>"Unknown error");throw new Error(`Geocoding failed: ${i.status} - ${p}`)}const o=await i.json();if(console.log("Geocoding response:",o),!o.results||!Array.isArray(o.results)||o.results.length===0)return null;const s=o.results[0],c=s.position,m=s.address;if(!c||!d.isValidCoordinate(c.lon,c.lat))throw new Error("Invalid coordinates received from geocoding service");const a=l.MAP.SEARCH_RADIUS;return{name:m?.freeformAddress||t,center:{lat:c.lat,lon:c.lon},bbox:{minLat:c.lat-a,maxLat:c.lat+a,minLon:c.lon-a,maxLon:c.lon+a}}}updateCurrentLocationDisplay(t){const e=document.getElementById("current-location");e.textContent=`📍 Currently viewing: ${t}`}toggleTrafficFlow(){const t=document.getElementById("toggle-traffic-flow");if(!this.map||!this.map.isStyleLoaded()){console.warn("Map not ready for layer toggle");return}let e=null;if(this.map.getLayer("traffic-flow")?e="traffic-flow":this.map.getLayer("simple-traffic")&&(e="simple-traffic"),e){const n=this.map.getLayoutProperty(e,"visibility");n==="visible"||n===void 0?(this.map.setLayoutProperty(e,"visibility","none"),t.classList.remove("active"),t.textContent="Traffic Flow (OFF)",console.log(`${e} layer hidden`)):(this.map.setLayoutProperty(e,"visibility","visible"),t.classList.add("active"),t.textContent="Traffic Flow",console.log(`${e} layer shown`))}else console.warn("No traffic flow layer found. Available layers:",this.map.getStyle().layers.map(n=>n.id)),t.textContent="Traffic Flow (Unavailable)"}toggleTrafficIncidents(){const t=document.getElementById("toggle-traffic-incidents");if(!this.map||!this.map.isStyleLoaded()){console.warn("Map not ready for layer toggle");return}if(this.map.getLayer("traffic-incidents-tiles")){const e=this.map.getLayoutProperty("traffic-incidents-tiles","visibility");e==="visible"||e===void 0?(this.map.setLayoutProperty("traffic-incidents-tiles","visibility","none"),t.classList.remove("active"),t.textContent="Traffic Incidents (OFF)",console.log("Traffic incidents layer hidden")):(this.map.setLayoutProperty("traffic-incidents-tiles","visibility","visible"),t.classList.add("active"),t.textContent="Traffic Incidents",console.log("Traffic incidents layer shown"))}else console.warn("Traffic incidents layer not found. Available layers:",this.map.getStyle().layers.map(e=>e.id)),t.textContent="Traffic Incidents (Unavailable)"}async loadTrafficIncidents(){try{this.updateStatus("Loading traffic incidents...","loading");const t=document.getElementById("refresh-btn");t.disabled=!0,this.clearMarkers();const e=await this.fetchTrafficIncidents();e.length===0?(this.updateStatus("No incidents found","success"),this.displayNoIncidents()):(this.incidents=e,this.displayIncidents(),this.addMarkersToMap(),this.updateStatus(`Found ${e.length} incidents`,"success"))}catch(t){console.error("Error loading traffic incidents:",t),this.updateStatus(`Error: ${t.message}`,"error"),this.showDemoData()}finally{const t=document.getElementById("refresh-btn");t.disabled=!1}}async fetchTrafficIncidents(){console.log("Checking API key:",r.tomtomApiKey.substring(0,10)+"...");const t=r.currentLocation.bbox,e=`${t.minLon},${t.minLat},${t.maxLon},${t.maxLat}`,n=`https://api.tomtom.com/traffic/services/5/incidentDetails?key=${r.tomtomApiKey}&bbox=${e}&fields={incidents{type,geometry{type,coordinates},properties{iconCategory,magnitudeOfDelay,events{description,code,iconCategory},startTime,endTime}}}`;console.log("Fetching traffic data from TomTom API..."),console.log("Bounding box:",e);const i=await fetch(n);if(!i.ok)throw console.error("API Response error:",i.status,i.statusText),new Error(`TomTom API Error ${i.status}: ${i.statusText}`);const o=await i.json();return console.log("TomTom API response:",o),this.processIncidentsData(o)}processIncidentsData(t){return t.incidents?t.incidents.map(e=>{const n=e.properties,i=e.geometry;let o;return i.type==="Point"?o=i.coordinates:i.type==="LineString"||i.type==="MultiLineString"?o=(i.type==="LineString"?i.coordinates:i.coordinates[0])[0]:o=Array.isArray(i.coordinates[0])?i.coordinates[0]:i.coordinates,(!Array.isArray(o)||o.length<2)&&(console.warn("Invalid coordinates for incident:",e),o=[r.currentLocation.center.lon,r.currentLocation.center.lat]),{id:e.id||Math.random().toString(36),type:this.getIncidentType(n.iconCategory),description:this.getIncidentDescription(n.events),location:o,severity:this.getSeverity(n.magnitudeOfDelay),startTime:n.startTime,endTime:n.endTime,iconCategory:n.iconCategory}}):[]}getIncidentType(t){return{0:"Accident",1:"Fog",2:"Dangerous Conditions",3:"Rain",4:"Ice",5:"Lane Restrictions",6:"Lane Closure",7:"Road Closure",8:"Road Works",9:"Wind",10:"Flooding",11:"Detour",14:"Traffic Cluster"}[t]||"Unknown Incident"}getIncidentDescription(t){return!t||t.length===0?"No details available":t.map(e=>e.description).join(". ")}getSeverity(t){return t>=4?"critical":t>=2?"high":t>=1?"medium":"low"}displayIncidents(){const t=document.getElementById("incidents-list");t.innerHTML="",this.incidents.forEach(e=>{const n=this.createIncidentCard(e);t.appendChild(n)})}createIncidentCard(t){const e=document.createElement("div");e.className=`incident-card severity-${t.severity}`;const n=a=>{if(!a)return"Unknown";try{return new Date(a).toLocaleString()}catch{return console.warn("Invalid timestamp:",a),"Invalid time"}},i=a=>{if(!Array.isArray(a)||a.length<2)return"Location unavailable";const p=typeof a[0]=="number"?a[0].toFixed(4):"N/A";return`Lat: ${typeof a[1]=="number"?a[1].toFixed(4):"N/A"}, Lon: ${p}`},o=d.sanitizeHtml(t.type||"Unknown"),s=d.sanitizeHtml(t.description||"No description available"),c=d.sanitizeHtml(i(t.location)),m=d.sanitizeHtml(n(t.startTime));return e.innerHTML=`
      <div class="incident-type">${o}</div>
      <div class="incident-description">${s}</div>
      <div class="incident-location">📍 ${c}</div>
      <div class="incident-time">⏰ Started: ${m}</div>
    `,e}addMarkersToMap(){!this.map||this.isDestroyed||this.incidents.forEach(t=>{if(!Array.isArray(t.location)||t.location.length<2){console.warn("Invalid location for incident:",t);return}const[e,n]=t.location;if(!d.isValidCoordinate(e,n)){console.warn("Invalid coordinate values for incident:",t);return}try{const i=new tt.Marker({color:this.getSeverityColor(t.severity)}).setLngLat([e,n]).addTo(this.map),o=d.sanitizeHtml(t.type||"Unknown"),s=d.sanitizeHtml(t.description||"No description available"),c=d.sanitizeHtml(t.severity||"unknown"),m=new tt.Popup({offset:25}).setHTML(`
          <div style="font-family: Arial, sans-serif;">
            <h3 style="margin: 0 0 10px 0; color: #333;">${o}</h3>
            <p style="margin: 0 0 5px 0; font-size: 14px;">${s}</p>
            <p style="margin: 0; font-size: 12px; color: #666;">Severity: ${c}</p>
          </div>
        `);i.setPopup(m),this.markers.push(i)}catch(i){console.warn("Error adding marker for incident:",t,i)}})}getSeverityColor(t){return{low:"#4caf50",medium:"#ff9800",high:"#f44336",critical:"#9c27b0"}[t]||"#666"}clearMarkers(){this.markers.forEach(t=>t.remove()),this.markers=[]}displayNoIncidents(){const t=document.getElementById("incidents-list");t.innerHTML=`
      <div class="no-incidents">
        No traffic incidents reported in this area at the moment.
      </div>
    `}showDemoData(){this.incidents=this.getDemoIncidents(),this.displayIncidents(),this.updateStatus("Showing demo data (API key required for live data)","success")}showDemoMode(){const t=document.getElementById("map");t.innerHTML=`
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; color: #666; text-align: center; padding: 2rem;">
        <div>
          <h3>Map View</h3>
          <p>TomTom Maps integration</p>
          <p><small>${r.currentLocation.name}</small></p>
        </div>
      </div>
    `}getDemoIncidents(){const t=r.currentLocation.center;return[{id:"demo1",type:"Road Works",description:"Construction work on the main carriageway. Expect delays.",location:[t.lon,t.lat],severity:"medium",startTime:new Date().toISOString(),endTime:null},{id:"demo2",type:"Lane Restrictions",description:"One lane closed due to maintenance work.",location:[t.lon+.003,t.lat+.007],severity:"low",startTime:new Date(Date.now()-36e5).toISOString(),endTime:null},{id:"demo3",type:"Accident",description:"Minor vehicle collision reported. Traffic moving slowly.",location:[t.lon-.007,t.lat-.013],severity:"high",startTime:new Date(Date.now()-18e5).toISOString(),endTime:null}]}updateStatus(t,e="loading"){const n=document.getElementById("status");n.textContent=t,n.className=`status ${e}`}}document.addEventListener("DOMContentLoaded",()=>{new u});
